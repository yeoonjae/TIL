> ğŸ“š ë³¸ ê¸€ì€ í† ë¹„ì˜ ìŠ¤í”„ë§ 3.1ì„ ì½ê³  ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤. 

<br>

# **7ì¥ ìŠ¤í”„ë§ í•µì‹¬ê¸°ìˆ ì˜ ì‘ìš© (2)**
* ìŠ¤í”„ë§ì˜ 3ëŒ€ í•µì‹¬ ê¸°ìˆ 
    1. IoC/DI
    2. ì„œë¹„ìŠ¤ ì¶”ìƒí™”
    3. AOP

---
## **DIë¥¼ ì´ìš©í•´ ë‹¤ì–‘í•œ êµ¬í˜„ ë°©ë²• ì ìš©í•˜ê¸°** 
* ìš´ì˜ ì¤‘ì¸ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•˜ëŠ” ì •ë³´ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ì‘ì—…ì„ ë§Œë“¤ ë•Œ ê°€ì¥ ë¨¼ì € ê³ ë ¤í•´ì•¼ í•  ì‚¬í•­ì€ ë™ì‹œì„± ë¬¸ì œë‹¤. 
* ë”°ë¼ì„œ ìë°”ì—ì„œ ì œê³µë˜ëŠ” ê¸°ìˆ ì„ ì´ìš©í•˜ì—¬ ì–´ëŠì •ë„ ì•ˆì „í•œ ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½í•´ë³´ì. 

### **ConcurrentHashMapì„ ì´ìš©í•œ ìˆ˜ì • ê°€ëŠ¥ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬**
* `ConcurrentHashMap`ì€ ë°ì´í„° ì¡°ì‘ ì‹œ ì „ì²´ ë°ì´í„°ì— ë½ì„ ê±¸ì§€ ì•Šê³  ì¡°íšŒëŠ” ì•„ì˜ˆ ë½ì„ ê±¸ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ ì•ˆì „í•˜ë©´ì„œ ì„±ëŠ¥ì ìœ¼ë¡œ ë³´ì¥ë˜ëŠ” ë™ê¸°í™”ëœ HashMapìœ¼ë¡œ ì´ìš©í•˜ê¸°ì— ì ë‹¹í•˜ë‹¤. 

```java
public class ConcurrentHashMapSqlRegistry implements UpdatableSqlRegistry {
	private Map<String, String> sqlMap = new ConcurrentHashMap<String, String>();

	public String findSql(String key) throws SqlNotFoundException {
		String sql = sqlMap.get(key);
		if (sql == null)  throw new SqlNotFoundException(key + "ë¥¼ ì´ìš©í•´ì„œ SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
		else return sql;
	}

	public void registerSql(String key, String sql) { sqlMap.put(key, sql);	}

	public void updateSql(String key, String sql) throws SqlUpdateFailureException {
		if (sqlMap.get(key) == null) {
			throw new SqlUpdateFailureException(key + "ì— í•´ë‹¹í•˜ëŠ” SQLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
		}
		
		sqlMap.put(key, sql);
	}

	public void updateSql(Map<String, String> sqlmap) throws SqlUpdateFailureException {
		for(Map.Entry<String, String> entry : sqlmap.entrySet()) {
			updateSql(entry.getKey(), entry.getValue());
		}
	}
}

```
```xml
<!-- sql service -->
<bean id="sqlService" class="springbook.user.sqlservice.OxmSqlService">
    <property name="unmarshaller" ref="unmarshaller" /> 
    <property name="sqlRegistry" ref="sqlRegistry" />
</bean>

<bean id="sqlRegistry" class="springbook.user.sqlservice.updatable.ConcurrentHashMapSqlRegistry">
</bean>
```

### **ë‚´ì¥í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì´ìš©í•œ SQL ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë§Œë“¤ê¸°**
> ë‚´ì¥í˜• DBëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë‚´ì¥ë¼ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ í•¨ê»˜ ì‹œì‘ë˜ê³  ì¢…ë£Œë˜ëŠ” DBë¥¼ ë§í•œë‹¤. 
* ë‚´ì¥í˜• DB(embedded DB)ë¥¼ ì´ìš©í•´ SQLì„ ì €ì¥í•˜ê³  ìˆ˜ì •í•´ë³´ì. 
* ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì¸ë±ìŠ¤ë¥¼ ì´ìš©í•œ ìµœì í™”ëœ ê²€ìƒ‰ì„ ì§€ì›í•˜ê³  ë™ì‹œì— ë§ì€ ìš”ì²­ì„ ì²˜ë¦¬í•˜ë©´ì„œ ì•ˆì •ì ì¸ ë³€ê²½ ì‘ì—…ì´ ê°€ëŠ¥í•œ ê¸°ìˆ ì´ë‹¤. 
* ë°ì´í„°ëŠ” ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì— IOë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¶€í•˜ê°€ ì ì–´ì„œ ì„±ëŠ¥ì´ ë›°ì–´ë‚˜ë‹¤. 
* ë˜í•œ Map ê³¼ ê°™ì€ ì»¬ë ‰ì…˜ì´ë‚˜ ì˜¤ë¸Œì íŠ¸ë¥¼ ì´ìš©í•´ ë©”ëª¨ë¦¬ì— ë°ì´í„°ë¥¼ ì €ì¥í•´ë‘ëŠ” ë°©ë²•ì— ë¹„í•´ ë§¤ìš° íš¨ê³¼ì ì´ê³  ì•ˆì •ì ì¸ ë°©ë²•ìœ¼ë¡œ ê²€ìƒ‰, ìˆ˜ì •, ë“±ë¡, ìµœì í™”ëœ ë½í‚¹, ê²©ë¦¬ìˆ˜ì¤€, íŠ¸ëœì­ì…˜ì„ ì ìš©í•  ìˆ˜ ìˆë‹¤.
* ìë°”ì—ì„œ ë§ì´ ì§€ì›ë˜ëŠ” ë‚´ì¥í˜• ë°ì´í„°ë² ì´ìŠ¤ëŠ” `Derby`, `HSQL`, `H2` ë¥¼ ë½‘ì„ ìˆ˜ ìˆë‹¤. 
* ìŠ¤í”„ë§ì€ ë‚´ì¥í˜• DBë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì‘ì—…ì„ ì§€ì›í•˜ëŠ” ë‚´ì¥í˜„ DB ë¹Œë”ë¥¼ ì œê³µí•œë‹¤. 
    * ë‚´ì¥í˜• DB ì¸ìŠ¤í„´ìŠ¤ëŠ” ë³´í†µ ê³ ìœ í•œ JDBC ì ‘ì† URLì„ í†µí•´ ì—°ê²°ì„ ì‹œë„í•˜ë©´ JDBC ë“œë¼ì´ë²„ ë‚´ì—ì„œ ì´ë¥¼ ìƒì„±í•´ì¤€ë‹¤. 
```java
new EmbeddedDatabaseBuilder()
  .generateUniqueName(true)
  .setType(H2)  // ë‚´ì¥í˜• DB ì¢…ë¥˜
  .setScriptEncoding("UTF-8")   
  .ignoreFailedDrops(true)
  .addScript("schema.sql") // í…Œì´ë¸” ìƒì„±ê³¼ ë°ì´í„° ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ì‚¬ìš©í•  SQL ë¬¸ì¥ì„ ë‹´ì€ SQL ìŠ¤í¬ë¦½íŠ¸ì˜ ìœ„ì¹˜ ì§€ì •. SQL ìŠ¤í¬ë¦½íŠ¸ëŠ” í•˜ë‚˜ ì´ìƒì„ ì§€ì •í•  ìˆ˜ ìˆìŒ 
  .addScripts("user_data.sql", "country_data.sql")
  .build(); // ì£¼ì–´ì§„ ì¡°ê±´ì— ë§ëŠ” ë‚´ì¥í˜• DBë¥¼ ì¤€ë¹„í•˜ê³  ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ëª¨ë‘ ì‹¤í–‰í•œ ë’¤ ì´ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” EmbeddedDatabaseë¥¼ ëŒë ¤ì¤€ë‹¤. 
```
> **ë‚´ì¥í˜• DBì˜ íŠ¸ëœì­ì…˜ ê²©ë¦¬ìˆ˜ì¤€ ì§€ì›**<br>
> íŠ¸ëœì­ì…˜ ê²©ë¦¬ìˆ˜ì¤€ì´ READ_UNCOMMITEDë¼ê³  ë¶ˆë¦¬ëŠ” ë ˆë²¨ 0ì€ í•œ íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ê¸° ì „ì˜ ì‘ì—… ë‚´ìš©ì„ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì½ì„ ìœ„í—˜ì„±ì´ ìˆë‹¤. ë§Œì•½ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ëë‚˜ê¸° ì „ì— ë³€ê²½í•œ ì •ë³´ë¥¼ ì½ì–´ë²„ë ¸ëŠ”ë° í•´ë‹¹ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ì–´ë²„ë¦¬ë©´ ì‹¤ì œë¡œëŠ” DBì— ë°˜ì˜ë˜ì§€ ì•Šì€ ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤. 

---
## **ìŠ¤í”„ë§ 3.1ì˜ DI**
ìŠ¤í”„ë§ 3.1ì€ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë©”íƒ€ì •ë³´ë¥¼ ì‘ì„±í•˜ê³ , ë¯¸ë¦¬ ì •í•´ì§„ ì •ì±…ê³¼ ê´€ë¡€ë¥¼ í™œìš©í•´ì„œ ê°„ê²°í•œ ì½”ë“œì— ë§ì€ ë‚´ìš©ì„ ë‹´ì„ ìˆ˜ ìˆëŠ” ë°©ì‹ì„ ì ê·¹ ë„ì…í•˜ê³  ìˆë‹¤. ì§€ê¸ˆê¹Œì§€ ë§Œë“  ì½”ë“œë“¤ì„ ìµœì‹  3.1 ë²„ì „ì˜ DI ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•´ë³´ì. 

### **ìë°” ì½”ë“œë¥¼ ì´ìš©í•œ ë¹ˆ ì„¤ì •**
* ì²«ë²ˆì§¸ ì‘ì—…ì€ XMLì„ ì—†ì• ëŠ” ì‘ì—…ì´ë‹¤. ì–´ë…¸í…Œì´ì…˜ê³¼ ìë°” ì½”ë“œë¡œ XMLì„ ëŒ€ì²´í•´ë³´ì.
```java
@Configuration
@EnableTransactionManagement
public class TestApplicationContext {
	/**
	 * DBì—°ê²°ê³¼ íŠ¸ëœì­ì…˜
	 */
	
	@Bean
	public DataSource dataSource() {
		SimpleDriverDataSource ds = new SimpleDriverDataSource();
		ds.setDriverClass(Driver.class);
		ds.setUrl("jdbc:mysql://localhost/springbook?characterEncoding=UTF-8");
		ds.setUsername("spring");
		ds.setPassword("book");
		return ds;
	}
	
	@Bean
	public PlatformTransactionManager transactionManager() {
		DataSourceTransactionManager tm = new DataSourceTransactionManager();
		tm.setDataSource(dataSource());
		return tm;
	}
	
	/**
	 * ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ & í…ŒìŠ¤íŠ¸ìš© ë¹ˆ
	 */
	
	@Autowired SqlService sqlService;
	
	@Bean 
	public UserDao userDao() {
		UserDaoJdbc dao = new UserDaoJdbc();
		dao.setDataSource(dataSource());
		dao.setSqlService(this.sqlService);
		return dao;
	}
	
	@Bean
	public UserService userService() {
		UserServiceImpl service = new UserServiceImpl();
		service.setUserDao(userDao());
		service.setMailSender(mailSender());
		return service;
	}
	
	@Bean
	public UserService testUserService() {
		TestUserService testService = new TestUserService();
		testService.setUserDao(userDao());
		testService.setMailSender(mailSender());
		return testService;
	}
	
	@Bean
	public MailSender mailSender() {
		return new DummyMailSender();
	}
	
	/**
	 * SQLì„œë¹„ìŠ¤
	 */
	
	@Bean
	public SqlService sqlService() {
		OxmSqlService sqlService = new OxmSqlService();
		sqlService.setUnmarshaller(unmarshaller());
		sqlService.setSqlRegistry(sqlRegistry());
		return sqlService;
	}
	
	@Bean
	public SqlRegistry sqlRegistry() {
		EmbeddedDbSqlRegistry sqlRegistry = new EmbeddedDbSqlRegistry();
		sqlRegistry.setDataSource(embeddedDatabase());
		return sqlRegistry;
	}
	
	@Bean
	public Unmarshaller unmarshaller() {
		Jaxb2Marshaller marshaller = new Jaxb2Marshaller();
		marshaller.setContextPath("springbook.user.sqlservice.jaxb");
		return marshaller;
	}
	
	@Bean 
	public DataSource embeddedDatabase() {
		return new EmbeddedDatabaseBuilder()
			.setName("embeddedDatabase")
			.setType(HSQL)
			.addScript("classpath:springbook/user/sqlservice/updatable/sqlRegistrySchema.sql")
			.build();
	}
}

```
* `test-application.xml` -> `TestApplicationContext.java`ë¡œ ë³€ê²½í•´ì£¼ê³  `@Configuration`ì„ ë¶™ì—¬ì„œ DI ì„¤ì •íŒŒì¼ì´ë¼ëŠ” ê²ƒì„ ì•Œë¦°ë‹¤. 
* `@Configuration`ì„ ë¶™ì´ë©´ ê¸°ì¡´ì— xmlì—ì„œ ì‚¬ìš©í–ˆë˜ `<context:annotation-config/>`ë¥¼ ë¶™ì´ì§€ì•Šì•„ë„ ë¹ˆ í›„ì²˜ë¦¬ê¸°ë¥¼ ì§ì ‘ ë“±ë¡ì‹œì¼œì£¼ê¸° ë•Œë¬¸ì— ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. 
* `<bean>` -> `@Bean` : ë¹ˆìœ¼ë¡œ ë“±ë¡í•  ì •ë³´ëŠ” `@Bean` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ì¤€ë‹¤. 
    * ë©”ì†Œë“œ ì´ë¦„ì€ <bean>ì˜ id ê°’ìœ¼ë¡œ í•œë‹¤. 
* ìë°” ì½”ë“œì—ì„œ XMLì— ì •ì˜ëœ ë¹ˆì„ ì°¸ì¡°í•˜ë ¤ë©´ `@Autowired`ê°€ ë¶™ì€ í•„ë“œë¥¼ ì„ ì–¸í•´ì„œ XMLì— ì •ì˜ëœ ë¹ˆì„ ì»¨í…Œì´ë„ˆê°€ ì£¼ì…í•´ì£¼ê²Œ í•´ì•¼ í•œë‹¤.
* `@Resource`ëŠ” `@Autowired`ì™€ ìœ ì‚¬í•˜ê²Œ í•„ë“œì— ë¹ˆì„ ì£¼ì…ë°›ì„ ë•Œ ì‚¬ìš©í•œë‹¤. 
    * `@Autowired`ëŠ” í•„ë“œì˜ íƒ€ì…ì„ ê¸°ì¤€ìœ¼ë¡œ ë¹ˆì„ ì°¾ê³ ,
    * `@Resource`ëŠ” í•„ë“œì˜ ì´ë¦„ì„ ê¸°ì¤€ìœ¼ë¡œ ë¹ˆì„ ì°¾ëŠ”ë‹¤. 
* `<tx:annotation-driven />` -> `@EnableTransactionManagement` : ë‚´ë¶€ì ìœ¼ë¡œ ë³µì¡í•œ ë¡œìš° ë ˆë²¨ì˜ ë¹ˆì„ ë“±ë¡í•´ì£¼ëŠ” ì „ìš© íƒœê·¸ì— ëŒ€ì‘ë˜ëŠ” ì–´ë…¸í…Œì´ì…˜ì„ ì œê³µí•´ì¤€ë‹¤. 
* ìŠ¤í”„ë§ 3.1ì€ `@Enable`ë¡œ ì‹œì‘í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆê²Œ ë‹¤ì–‘í•œ ì–´ë…¸í…Œì´ì…˜ì„ ì œê³µí•œë‹¤. ê·¸ì¤‘ í•˜ë‚˜ê°€ `@EnableTransactionManagement`ì´ë‹¤.

<br>

## **ë¹ˆ ìŠ¤ìºë‹ê³¼ ìë™ ì™€ì´ì–´ë§**
### @Autowiredë¥¼ ì´ìš©í•œ ìë™ì™€ì´ì–´ë§
```java
public class UserDaoJdbc implements UserDao {
	
	@Autowired
	public void setDataSource(DataSource dataSource) {
		this.jdbcTemplate = new JdbcTemplate(dataSource);
	}
	
	private JdbcTemplate jdbcTemplate;
	
	@Autowired
	private SqlService sqlService;

	public void setSqlService(SqlService sqlService) {
		this.sqlService = sqlService;
	}
    ...
}
```
* ìë™ì™€ì´ì–´ë§ì„ ì‚¬ìš©í•˜ë©´ ì¡°ê±´ì— ë§ëŠ” ë¹ˆì„ ì°¾ì•„ ìë™ìœ¼ë¡œ ìˆ˜ì •ì ë©”ì†Œë“œë‚˜ í•„ë“œì— ë„£ì–´ì¤€ë‹¤. ìë™ì™€ì´ì–´ë§ì„ ì‚¬ìš©í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ ì´ë¦„ì´ë‚˜ íƒ€ì…ì„ ê¸°ì¤€ìœ¼ë¡œ ì£¼ì…ë  ë¹ˆì„ ì°¾ì•„ì£¼ê¸° ë•Œë¬¸ì— XMLì˜ ì½”ë“œë¥¼ ëŒ€í­ ì¤„ì¼ ìˆ˜ ìˆë‹¤.
* ì£¼ì…í•  ëŒ€ìƒì„ ì§ì ‘ ì§€ì •í•  ìˆ˜ë„ ìˆë‹¤. 
* `@Autowired`ëŠ” ìˆ˜ì •ì ë©”ì†Œë“œê°€ ìˆìœ¼ë©´ íŒŒë¼ë¯¸í„° íƒ€ì…ì„ ë³´ê³  ì£¼ì… ê°€ëŠ¥í•œ ë¹ˆì„ ëª¨ë‘ ì°¾ëŠ”ë‹¤. 
    * ë§Œì•½ ë‘ ê°œ ì´ìƒì´ë©´ í”„ë¡œí¼í‹°ì™€ ì´ë¦„ì´ ë™ì¼í•œ ë¹ˆì´ ìˆëŠ”ì§€ ì°¾ëŠ”ë‹¤. 
    * ë‘˜ ë‹¤ ë¹„êµí•´ë„ ì°¾ì§€ ëª»í•˜ë©´ ì—ëŸ¬ê°€ ë‚œë‹¤. 

### **@Componentë¥¼ ì´ìš©í•œ ìë™ ë¹ˆ ë“±ë¡**
```java
@Component
public class UserDaoJdbc implements UserDao {
    ...
}
```
* `@Component`ëŠ” í´ë˜ìŠ¤ì— ë¶€ì—¬ë˜ëŠ” ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ `@Component`ê°€ ë¶™ì€ í´ë˜ìŠ¤ëŠ” ë¹ˆ ìŠ¤ìºë„ˆë¥¼ í†µí•´ ìë™ìœ¼ë¡œ ë¹ˆìœ¼ë¡œ ë“±ë¡ëœë‹¤. 
    * ì •í™•íˆëŠ” `@Component` ë˜ëŠ” `@Component`ë¥¼ ë©”íƒ€ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ê°–ê³  ìˆëŠ” ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ í´ë˜ìŠ¤ê°€ ìë™ ë¹ˆ ë“±ë¡ ëŒ€ìƒì´ ëœë‹¤. 
```java

@Configuration
@EnableTransactionManagement
@ComponentScan(basePackages="springbook.user")
public class TestApplicationContext {
    ...
}
```
* `@ComponentScan` : `@Component` ì–´ë…¸í…Œì´ì…˜ì´ ë‹¬ë¦° í´ë˜ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ì°¾ì•„ì„œ ë¹ˆì„ ë“±ë¡í•˜ê²Œ í•˜ê¸° ìœ„í•´ì„  ë¹ˆ ìŠ¤ìºë‹ ì–´ë…¸í…Œì´ì…˜ ì •ì˜ê°€ í•„ìš”í•˜ë‹¤. 
    * `basePackages` ì—˜ë¦¬ë¨¼íŠ¸ëŠ” `@Component`ê°€ ë¶™ì€ í´ë˜ìŠ¤ë¥¼ ìŠ¤ìº”í•  ê¸°ì¤€ íŒ¨í‚¤ì§€ë¥¼ ì§€ì •í•  ë•Œ ì‚¬ìš©í•œë‹¤. 
    * íŒ¨í‚¤ì§€ëŠ” ì—¬ëŸ¬ê°œë¥¼ ë„£ì„ ìˆ˜ë„ ìˆë‹¤. 
    * `@Component` ê°€ ë¶™ì€ í´ë˜ìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ìë™ ë“±ë¡í•´ì£¼ëŠ” ì—­í• ì„ í•˜ë©° ë¹ˆ ì´ë¦„ì€ ë”°ë¡œ ì§€ì •í•˜ì§€ ì•Šì•˜ì„ ì‹œ í´ë˜ìŠ¤ ì´ë¦„ì˜ ì²« ê¸€ìë¥¼ ì†Œë¬¸ìë¡œ ë°”ê¿”ì„œ ì‚¬ìš©í•œë‹¤. 

<br>

## **ì»¨í…ìŠ¤íŠ¸ ë¶„ë¦¬ì™€ @Import**
```java
@Configuration
public class TestAppContext {
	@Bean
	public UserService testUserService() {
		return new TestUserService();
	}
	
	@Bean
	public MailSender mailSender() {
		return new DummyMailSender();
	}
}

```
```java
@Configuration
public class SqlServiceContext {
	@Bean
	public SqlService sqlService() {
		OxmSqlService sqlService = new OxmSqlService();
		sqlService.setUnmarshaller(unmarshaller());
		sqlService.setSqlRegistry(sqlRegistry());
		return sqlService;
	}
	
	@Bean
	public SqlRegistry sqlRegistry() {
		EmbeddedDbSqlRegistry sqlRegistry = new EmbeddedDbSqlRegistry();
		sqlRegistry.setDataSource(embeddedDatabase());
		return sqlRegistry;
	}
	
	@Bean
	public Unmarshaller unmarshaller() {
		Jaxb2Marshaller marshaller = new Jaxb2Marshaller();
		marshaller.setContextPath("springbook.user.sqlservice.jaxb");
		return marshaller;
	}
	
	@Bean 
	public DataSource embeddedDatabase() {
		return new EmbeddedDatabaseBuilder()
			.setName("embeddedDatabase")
			.setType(HSQL)
			.addScript("classpath:springbook/user/sqlservice/updatable/sqlRegistrySchema.sql")
			.build();
	}
}

```
```java
@Configuration
@EnableTransactionManagement
@ComponentScan(basePackages="springbook.user")
@Import(SqlServiceContext.class)
public class AppContext {
	@Bean
	public DataSource dataSource() {
		SimpleDriverDataSource ds = new SimpleDriverDataSource();
		ds.setDriverClass(Driver.class);
		ds.setUrl("jdbc:mysql://localhost/springbook?characterEncoding=UTF-8");
		ds.setUsername("spring");
		ds.setPassword("book");
		return ds;
	}
	
	@Bean
	public PlatformTransactionManager transactionManager() {
		DataSourceTransactionManager tm = new DataSourceTransactionManager();
		tm.setDataSource(dataSource());
		return tm;
	}
}

```
* ì„±ê²©ì´ ë‹¤ë¥¸ DIì •ë³´ë¥¼ ë¶„ë¦¬í•˜ì. 
    * ë‘ ê°œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í•µì‹¬ ë¹ˆ ì •ë³´ë¥¼ ë‹´ê³ ìˆê³ , í•˜ë‚˜ëŠ” Test ì™€ ê´€ë ¨ëœ ì •ë³´ë§Œ ê°–ê³ ìˆë‹¤. 
* `@ImportResource` --> `@Import(SqlServiceContext.class)`ë¡œ ë³€ê²½í•´ì¤€ë‹¤.

### **í”„ë¡œíŒŒì¼**
```java
@Configuration
@EnableTransactionManagement
@ComponentScan(basePackages="springbook.user")
@Import(SqlServiceContext.class)
public class AppContext {
	@Bean
	public DataSource dataSource() {
		SimpleDriverDataSource ds = new SimpleDriverDataSource();
		ds.setDriverClass(Driver.class);
		ds.setUrl("jdbc:mysql://localhost/springbook?characterEncoding=UTF-8");
		ds.setUsername("spring");
		ds.setPassword("book");
		return ds;
	}
	
	@Bean
	public PlatformTransactionManager transactionManager() {
		DataSourceTransactionManager tm = new DataSourceTransactionManager();
		tm.setDataSource(dataSource());
		return tm;
	}
	
	@Configuration
	@Profile("production")
	public static class ProductionAppContext {
		@Bean
		public MailSender mailSender() {
			JavaMailSenderImpl mailSender = new JavaMailSenderImpl();
			mailSender.setHost("localhost");
			return mailSender;
		}
	}
	
	@Configuration
	@Profile("test")
	public static class TestAppContext {
		@Bean
		public UserService testUserService() {
			return new TestUserService();
		}
		
		@Bean
		public MailSender mailSender() {
			return new DummyMailSender();
		}
	}

}

	
	@Bean
	public PlatformTransactionManager transactionManager() {
		DataSourceTransactionManager tm = new DataSourceTransactionManager();
		tm.setDataSource(dataSource());
		return tm;
	}
	
	@Configuration
	@Profile("production")
	public static class ProductionAppContext {
		@Bean
		public MailSender mailSender() {
			JavaMailSenderImpl mailSender = new JavaMailSenderImpl();
			mailSender.setHost("localhost");
			return mailSender;
		}
	}
	
	@Configuration
	@Profile("test")
	public static class TestAppContext {
		@Bean
		public UserService testUserService() {
			return new TestUserService();
		}
		
		@Bean
		public MailSender mailSender() {
			return new DummyMailSender();
		}
	}

}
```
 * ìŠ¤í”„ë§ 3.1ì€ í™˜ê²½ì— ë”°ë¼ì„œ ë¹ˆ ì„¤ì •ì •ë³´ê°€ ë‹¬ë¼ì ¸ì•¼ í•˜ëŠ” ê²½ìš°ì— ê°„ë‹¨íˆ ì„¤ì •ì •ë³´ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•œë‹¤. 
    * `@Profile(í”„ë¡œíŒŒì¼ ì´ë¦„)` : ì‹¤í–‰í™˜ê²½ì— ë”°ë¼ ë¹ˆ êµ¬ì„±ì´ ë‹¬ë¼ì§€ëŠ” ë‚´ìš©ì„ í”„ë¡œíŒŒì¼ë¡œ ì •ì˜í•´ì„œ ë§Œë“¤ì–´ë‘ê³ , ì‹¤í–‰ ì‹œì ì— ì–´ë–¤ í”„ë¡œíŒŒì¼ì˜ ë¹ˆ ì„¤ì •ì„ ì‚¬ìš©í• ì§€ ì§€ì •í•˜ëŠ” ê²ƒì´ë‹¤. 
    * `@ActiveProfiles(í”„ë¡œíŒŒì¼ ì´ë¦„)` : í™œì„± í”„ë¡œíŒŒì¼ì„ ì§€ì •í•  ë•Œ ì‚¬ìš©í•œë‹¤. 
* ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” ëª¨ë‘ BeanFactoryë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ê³  ìˆë‹¤. 
    * BeanFactoryì˜ êµ¬í˜„ í´ë˜ìŠ¤ ì¤‘ DefaultListableBeanFactoryê°€ ìˆëŠ”ë° ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” ì´ í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ë¹ˆì„ ë“±ë¡í•˜ê³  ê´€ë¦¬í•œë‹¤. 
    * ë”°ë¼ì„œ ë¹ˆìœ¼ë¡œ ë“±ë¡ëœ ëª¨ë“  í´ë˜ìŠ¤ë¥¼ ë³´ê³  ì‹¶ì„ ë•Œ `DefaultListableBeanFactory.getBeanDefinitionNames()` ë¥¼ ì‚¬ìš©í•˜ë©´ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. 

<br>

### **í”„ë¡œí¼í‹° ì†ŒìŠ¤**

```properties
-- database.properties
db.driverClass=com.mysql.jdbc.Driver
db.url=jdbc:mysql://localhost/springbook?characterEncoding=UTF-8
db.username=spring
db.password=book
```

* í”„ë¡œíŒŒì¼ì„ ì´ìš©í•´ í…ŒìŠ¤íŠ¸í™˜ê²½ê³¼ ìš´ì˜í™˜ê²½ì—ì„œ ê° ë‹¤ë¥¸ ë¹ˆ ì„¤ì •ì„ í•˜ë„ë¡ í–ˆì§€ë§Œ dataSourceì˜ DB ì—°ê²°ì •ë³´ëŠ” ì¢…ì†ë˜ì–´ ìˆë‹¤. 
* ìš´ì˜í™˜ê²½ì´ë¼ë©´ JNDIë¥¼ ì‚¬ìš©í•´ ì„œë²„ê°€ ì œê³µí•˜ëŠ” DataSource ë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ìˆë‹¤. 
* AppContextì˜ dataSource() ë©”ì†Œë“œê°€ ìœ„ì˜ database.properties íŒŒì¼ì˜ ë‚´ìš©ì„ ê°€ì ¸ì™€ DB ì—°ê²°ì •ë³´ í”„ë¡œí¼í‹°ì— ë„£ì–´ì£¼ë„ë¡ ë§Œë“¤ì–´ë³´ì. 
```java
@Configuration
@EnableTransactionManagement
@ComponentScan(basePackages="springbook.user")
@Import(SqlServiceContext.class)
@PropertySource("/database.properties")
public class AppContext {
    ...
}
```
* í”„ë¡œí¼í‹° ì†ŒìŠ¤ ë“±ë¡ì—ëŠ” `@PropertySource` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•œë‹¤.